/*
 * Copyright (C) 2020 The poly network Authors
 * This file is part of The poly network library.
 *
 * The  poly network  is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * The  poly network  is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * You should have received a copy of the GNU Lesser General Public License
 * along with The poly network .  If not, see <http://www.gnu.org/licenses/>.
 */
package quorum

import (
	"encoding/hex"
	"errors"
	common2 "github.com/ethereum/go-ethereum/common"
	"github.com/ontio/ontology-crypto/keypair"
	"github.com/polynetwork/poly/account"
	"github.com/polynetwork/poly/common"
	"github.com/polynetwork/poly/consensus/vbft/config"
	"github.com/polynetwork/poly/core/states"
	"github.com/polynetwork/poly/core/store/leveldbstore"
	"github.com/polynetwork/poly/core/store/overlaydb"
	"github.com/polynetwork/poly/core/types"
	"github.com/polynetwork/poly/native"
	common4 "github.com/polynetwork/poly/native/service/cross_chain_manager/common"
	"github.com/polynetwork/poly/native/service/governance/node_manager"
	"github.com/polynetwork/poly/native/service/governance/side_chain_manager"
	common3 "github.com/polynetwork/poly/native/service/header_sync/common"
	"github.com/polynetwork/poly/native/service/header_sync/quorum"
	"github.com/polynetwork/poly/native/service/utils"
	"github.com/polynetwork/poly/native/storage"
	"testing"
	"time"
)

var (
	acct = account.NewAccount("")

	getNativeFunc = func(args []byte, db *storage.CacheDB) *native.NativeService {
		signAddr, _ := types.AddressFromBookkeepers([]keypair.PublicKey{acct.PublicKey})
		if db == nil {
			store, _ := leveldbstore.NewMemLevelDBStore()
			db = storage.NewCacheDB(overlaydb.NewOverlayDB(store))
			sink := common.NewZeroCopySink(nil)
			view := &node_manager.GovernanceView{
				TxHash: common.UINT256_EMPTY,
				Height: 0,
				View:   0,
			}
			view.Serialization(sink)
			db.Put(utils.ConcatKey(utils.NodeManagerContractAddress, []byte(node_manager.GOVERNANCE_VIEW)), states.GenRawStorageItem(sink.Bytes()))

			peerPoolMap := &node_manager.PeerPoolMap{
				PeerPoolMap: map[string]*node_manager.PeerPoolItem{
					vconfig.PubkeyID(acct.PublicKey): {
						Address:    acct.Address,
						Status:     node_manager.ConsensusStatus,
						PeerPubkey: vconfig.PubkeyID(acct.PublicKey),
						Index:      0,
					},
				},
			}
			sink.Reset()
			peerPoolMap.Serialization(sink)
			db.Put(utils.ConcatKey(utils.NodeManagerContractAddress,
				[]byte(node_manager.PEER_POOL), utils.GetUint32Bytes(0)), states.GenRawStorageItem(sink.Bytes()))

			sc := &side_chain_manager.SideChain{
				BlocksToWait: 1,
				Address:      signAddr,
				CCMCAddress:  common2.Hex2Bytes("901f8abd2afb170f24f1674d6aacdf39815f6cbe"),
			}
			sink.Reset()
			_ = sc.Serialization(sink)
			db.Put(utils.ConcatKey(utils.SideChainManagerContractAddress, []byte(side_chain_manager.SIDE_CHAIN), utils.GetUint64Bytes(106)), states.GenRawStorageItem(sink.Bytes()))
		}

		ns, _ := native.NewNativeService(db, &types.Transaction{SignedAddr: []common.Address{signAddr}}, uint32(time.Now().Unix()), 0, common.Uint256{0}, 0, args, false)
		return ns
	}

	gh    = "7b22706172656e7448617368223a22307863623537333530363563316633633334626236613166356439343838643338343261653530343364613366643761376164316139376333343032643866646339222c2273686133556e636c6573223a22307831646363346465386465633735643761616238356235363762366363643431616433313234353162393438613734313366306131343266643430643439333437222c226d696e6572223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030222c227374617465526f6f74223a22307833356161656131393862303033386232633537623534663765396133353036646361643538613965633236363137313963356437313539363261393966633561222c227472616e73616374696f6e73526f6f74223a22307830653164356666366335636234633030303833326232356538333866386162376234396534366338376135663436633261363965373731373037626630393461222c227265636569707473526f6f74223a22307838373537303230316162353238323865396537363863343233396538636262303334666633373736613933666333363361626231393831346265376531343531222c226c6f6773426c6f6f6d223a2230783030303030303030303030303030303030303030303030303030303030303030303030303030313030323030303030303030303030303030303030303030303030303030303030303030303030303830303030303030303030303030303030303030303030303030303030303030303030303030303038303030303030303030303030303230303030303030313030303030303030303030303030303030303830303030303030303130303830303030303030303030303030303030303030303030303130303030303030303030313030303030303030303030303030303030303030303031303430303030323030303034303030303030303030303030303838303030303030303030303030313030303030303030303030303030303430303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303230303030303030303030303030303030303030303030303030303030303031303030303030303032303030303030303031303830303030303030303030303030303030303034303030303030303030303030303030303034303030303030303032303030303030303030303030303030222c22646966666963756c7479223a22307831222c226e756d626572223a223078353462222c226761734c696d6974223a2230786130653665633565222c2267617355736564223a22307830222c2274696d657374616d70223a2230783566666265373632222c22657874726144617461223a2230786438383330313039303738343637363537343638383836373666333132653331333532653332383536633639366537353738303030303030303030303030303066393032326166383933393430336666366265623635666562356461383763613162353436386233653935646137363732353565393432353861663438653238653461363834366539333164646666386531636466383537393832316535393436613730383435356338373737363330616163396431653737303264313366376138363562323763393438633039643933366131623430386436653061666161353337626134653036633435303461306165393462666235353866306463656230376662623039653163323833303438623535316134333130393231393463303935343438343234613565636435636137636364616466616164313237613964376538386563393464343761346535366539323632353433646233396439323033636631613265353337333566383334623834313835643038333734663132316466303435333163373038323366386263646137343635303434613236376638346337636365376334373664346262613064323733653231386633343561626666653034623764626232613631373135346464363032366661313933626134633037313436313039633130656464356437623663303166393031346662383431336133616137353836623636656566313835306262623035376431343361613337636635326138376434333831313232666232333564313631356332343333353531346536323065353132316639373838356135323032366637623632663233616133386133323834643433373635373263306366626166363531636361383230306238343132643937653262363033656162386430393665633365343033316161373163393237383664613362373537343535376133356138303037336137353465343730326534383633646165323736643364303233623036663034613261366533313131323864393962656162333831643536356331363538613332386666646638353030623834313832656339653138393538393664626139353865396265303837396165396662633538313835353063393936316234616539353463393766643666353035363433326465336163303539333538333862363930323862613937303766313732653563316636393139373064303439336665326161323135353461616264633062303062383431626634313130643132386363323534373431316665333133353162376238336665393162653561363161313634353436363366626430636531616436633630343230316461653836653634643366346435643039323932396364666534356564313832306632316563613365666163613535366632343337303738386163313630316238343165313764373565363532323936346461333432623739303666633366613164333738643936306561626265316565363738333032613537633538356361323666376264656235353934333962376664626530643432623062323939636131643263653763303731636232653962383861616139363765343736363165326165363030222c226d697848617368223a22307836333734363936333631366332303632373937613631366537343639366536353230363636313735366337343230373436663663363537323631366536333635222c226e6f6e6365223a22307830303030303030303030303030303030222c2268617368223a22307831343036633463313638323365396634353733386663383533613638396132623163393034346462343737613336616162343963383735383766333931393263227d"
	h1    = "7b22706172656e7448617368223a22307835346433626437333434323133613265343136646663336464323432323839303633343532353463633339636634656166316362386163323565346334623031222c2273686133556e636c6573223a22307831646363346465386465633735643761616238356235363762366363643431616433313234353162393438613734313366306131343266643430643439333437222c226d696e6572223a22307830303030303030303030303030303030303030303030303030303030303030303030303030303030222c227374617465526f6f74223a22307834326539653932366265306133383766373566373765326535613161353862346538646635376261366465393636393562633737653830323736653933306564222c227472616e73616374696f6e73526f6f74223a22307835373063366136363061613436313161343232323265316466316239383164656438353563306230316139363935343136666361376665343534323834316534222c227265636569707473526f6f74223a22307862363434303864613662386665333961623736346166383865636531653863636131633335666439383864623537383036653939313338633632393336356130222c226c6f6773426c6f6f6d223a2230783030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c22646966666963756c7479223a22307831222c226e756d626572223a22307835346530222c226761734c696d6974223a2230783239623932373030222c2267617355736564223a22307830222c2274696d657374616d70223a2230783566666437393235222c22657874726144617461223a2230786438383330313039303738343637363537343638383836373666333132653331333532653332383536633639366537353738303030303030303030303030303066393032326166383933393430336666366265623635666562356461383763613162353436386233653935646137363732353565393432353861663438653238653461363834366539333164646666386531636466383537393832316535393436613730383435356338373737363330616163396431653737303264313366376138363562323763393438633039643933366131623430386436653061666161353337626134653036633435303461306165393462666235353866306463656230376662623039653163323833303438623535316134333130393231393463303935343438343234613565636435636137636364616466616164313237613964376538386563393464343761346535366539323632353433646233396439323033636631613265353337333566383334623834316165353565353136623632313332636636343938633230336163306130666131613237386463356532353862383839383337653061393537326635376666366130663137303762663961323034316366666362666239313965353462353034653937366137303765613965626663666163666530616132316136376138363731303066393031346662383431353565663466366432383532626339613066376262303332316363373236343330383838633132626431313163363563353630396232376664663862346333313638613432383231393563656366653635626339343930333637326164613564346536373363313934663838633630366638633234616538326662653631373830306238343136333439373065323364356436623738323937656538646662363063393832323063303932383535303965633839313066383662393332376433393436303435303862623833633932316464383532643761313665643230326535653863633433306362393434313963613135353336643331363962376532613563363737363031623834313630633831333764643139663238346437363137396338646631346561633438636336396261643865643964373834653266613630323264373837306437633033346666393339356161336133373834636536663731666563653866656236383337653133653934613534663965306661636265633863313961623763636239303162383431396232636436336438363966653736643636623437303739346264626130353635633130646162653261303834356334346632643635366235376565376639643566396231633731633261626533333862343833386336656336623836376531616362303831366562333266363137643063353762333637653263386433333130316238343161653664386665303165386433326335363734323431356165616337383066336263346230373032326566636333623562383138326337373864613939666364363930383930306535396130393665666339326461353930643866306636313731363462653964376436353464656635656630313361383963393761353433313031222c226d697848617368223a22307836333734363936333631366332303632373937613631366537343639366536353230363636313735366337343230373436663663363537323631366536333635222c226e6f6e6365223a22307830303030303030303030303030303030222c2268617368223a22307865353265636535613365636539306131626465396564346139323164623232303237303735653465376235626232386132333334623366373937613936333134227d"
	proof = "7b2261646472657373223a22307839303166386162643261666231373066323466313637346436616163646633393831356636636265222c2262616c616e6365223a22307830222c22636f646548617368223a22307833393731343662313134306635383963313461373065333034666535636264646532393863363934396465333335333035333965366639633562333337663664222c226e6f6e6365223a22307831222c2273746f7261676548617368223a22307835653366626133396164366561343239383065343835656134373665623162313438663665353235633532303963656232366465376431656339346134363462222c226163636f756e7450726f6f66223a5b2230786639303162316130653331626564353731363465623066316437663739353034373433663235663161316533343231633239376237343538656135643566353762373330363832366130316137333534326136313339373139653938626162646663663631393930323165313831363861323335316330353762366639366266313762616132613037336130376234613931373634613664336634323565633635626665333765303133303931343166636461336361363431393735633534323561663338646637303738336130643434613164656463363534313763653034643562343764356261393031623532356661616236313066373832646465323437616138633435653063646334336130646530336238666661383434653963383339353337666361303862356637383065343834323532613834326265333437316138326130343834613136396230396130333534393234316630623731313433363965303866323336656365633334323266393930626133313662343235643865363636386462666465633764613931376130366332363830373236663535636633356165333563383838366532336335336430353931383663323366313738666362323765623632363133343835623731383830613039333061343763636331343631613333393132353534303730643964666262323533353936313035373532373832353434373232646363306236616462323435613031363361383838666330663061353139643365336334326265323439656663326138663731623164666635326330343563653636623165323564613532336632613062333032333334363636336364373432393361313439313732393334383232613461313134343634666439313964336634613734353235626536643661663162613066613438373332306663326333396563353139343166303134303530646135313137613938653438323533356663653137626438346139303665326461613039383061303236336565373136666630396164323836646366643065613363343933643964316330643032396133356337623235303837333965336338386661386332353638306130643536613363306162346330386634656365663834333333613131623264393266633234616139336136343164613362346434303463303631636163666639613830222c22307866383531383038303830383038306130383931363961316334616563393631343662646536636634303535393737656337383865633065383034373331383239643335306331363036303536396566343830383038303830383038306130396435633265633164386463313332623866396565636163383837353735623135333130343434623961316437393931613131393433343866376134363735363830383038303830222c22307866383531383038303830383061303933643638376533623339333062366165666432303666616161356162656338306139623166343766633063373234663135303533396566336436323239623438303830383038306130353562373235396361666466636364623561343731653931613230386539623162333565333137616634623332333235386231623763363430646264306131373830383038303830383038303830222c2230786638363839663365326636376534383934653039633836656336353830326561373862643135643031343735663066663932343065303766366265313663356130343436623834366638343430313830613035653366626133396164366561343239383065343835656134373665623162313438663665353235633532303963656232366465376431656339346134363462613033393731343662313134306635383963313461373065333034666535636264646532393863363934396465333335333035333965366639633562333337663664225d2c2273746f7261676550726f6f66223a5b7b226b6579223a22307837346135666263623431396162376462616362623263393261346531363337333066306461356337326239313164656563663466303561366233323764306134222c2276616c7565223a22307831636431663036313466363733366332653830666532666336386139653036613439386463613762373037306166616665373565656338633939383437336463222c2270726f6f66223a5b22307866393031393161303437396134396637666332663463313437396432346331653630366634636538643139326631626666393363383966353131653536636362356336653830356361306633323834643961656331363836363361333961343438316338376461616536393663623038393033343630386361323062393266343766643562396137313061303235356431663963373931366635353632376438363862656137656131316365623936633961616336353065323835363434616261343966393337343233343561306162313764623535393939303763393338623764366363643861316163623034316631663933333336393938623639663334383430373363633166646339643261303262663064323636613566663633333364623438633163303165616263373066313164646637313831386634646365646133303063393262333438666563306338306130353437376335616230396664333862393765333137653661393039663535376137383862616235353766323162343738333237316230633333613538316664636130623766656264613231656538303536326363396163323965306430343562646539663438643161386237333034313666366565613733343235616137333432366130373166383530336633616633646366373963373362366137643237653265363833373163666133616335303435323239626662653936306266623837646535386130356132663462653663323339663834346439326236313131646431313432366432666662633633383932373666636166323363313432346162636363363535316130376462613635326430363037643261653537343364346539336636303466623933653666353766333566303966643266663030366161386332393164353834643830613030393138366366353731373761356337323431643530383766303763373830373738383835653534373630363435653538643835616638626638363264653061613061616164373836643539653961386534343635653632393632323131316436363061653166326333656661633039313735376462356336343234626163353966383038303830222c22307866383531383038303830383038303830383061303561303433366231646134363262363435323931303061323764376637333035613835303166386136643663633436303438363136643739623865353635363538303830383038303830383038306130653163656163333238643739643939633034646139376535623461643538363235616265356235303336326261653263336566616264336237363835336663323830222c223078663834336130323064356438373965663335353239623034306565613838656230376262643137333766356465616332383738343663326365386130313636333339656265306131613031636431663036313466363733366332653830666532666336386139653036613439386463613762373037306166616665373565656338633939383437336463225d7d5d7d"
	mtp   = "20000000000000000000000000000000000000000000000000000000000000000920452c8804755348eef67110ca6d93947f403aa38fcaf105f38895d43e182e8d9914000000000000000000000000000000000000010302000000000000001433082b802c4099040420533a9234bd80d71726ba06756e6c6f636b4a141ac77d322e3347b8de181304b7c118a7e89c6bc1142cd9d589d46122e4eddc495b49feda0b526c1af7000064a7b3b6e00d000000000000000000000000000000000000000000000000"
)

func prepare() (ns *native.NativeService, err error) {
	raw, err := hex.DecodeString(gh)
	if err != nil {
		return
	}
	p := common3.SyncGenesisHeaderParam{
		ChainID:       106,
		GenesisHeader: raw,
	}
	sink := common.NewZeroCopySink(nil)
	p.Serialization(sink)

	ns = getNativeFunc(sink.Bytes(), nil)
	h := quorum.NewQuorumHandler()
	err = h.SyncGenesisHeader(ns)
	return
}

func TestQuorumHandler_MakeDepositProposal(t *testing.T) {
	ns, err := prepare()
	if err != nil {
		t.Fatal(err)
	}

	rawProof, _ := hex.DecodeString(proof)
	rawH, _ := hex.DecodeString(h1)
	rawP, _ := hex.DecodeString(mtp)

	p := &common4.EntranceParam{
		SourceChainID:         106,
		HeaderOrCrossChainMsg: rawH,
		Extra:                 rawP,
		Height:                0,
		Proof:                 rawProof,
		RelayerAddress:        acct.Address[:],
	}
	sink := common.NewZeroCopySink(nil)
	p.Serialization(sink)

	ns = getNativeFunc(sink.Bytes(), ns.GetCacheDB())

	h := NewQuorumHandler()
	res, err := h.MakeDepositProposal(ns)
	if err != nil {
		t.Fatal(err)
	}
	if len(res.Args) == 0 {
		t.Fatal(errors.New("failed"))
	}
}
